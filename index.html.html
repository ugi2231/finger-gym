<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>손가락 운동 챌린지 (Finger Gym)</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: sans-serif;
    display: flex;
    height: 100vh;
    background: #222;
    color: white;
    overflow: hidden;
  }
  .ad {
    width: 160px;
    background: #f4f4f4;
    color: black;
    text-align: center;
    padding: 10px;
  }
  .container {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    overflow: hidden;
    position: relative;
  }
  #nickname {
    font-size: 20px;
    padding: 8px;
    margin-bottom: 10px;
    width: 250px;
  }
  #gameInfo {
    margin-bottom: 15px;
  }
  #gameArea {
    flex: 1;
    position: relative;
    width: 100%;
    max-width: 600px;
    background: #111;
    border-radius: 10px;
    overflow: hidden;
  }
  .dot {
    position: absolute;
    background: #2ecc71;
    border-radius: 50%;
    cursor: pointer;
    user-select: none;
  }
  #message {
    margin-top: 15px;
    font-size: 22px;
    min-height: 26px;
  }
  #result {
    margin-top: 8px;
    font-size: 24px;
    color: #0f0;
  }
  #restartBtn {
    margin-top: 15px;
    font-size: 18px;
    padding: 10px 20px;
    cursor: pointer;
    background: #27ae60;
    color: white;
    border: none;
    border-radius: 6px;
  }
  #ranking {
    margin-top: 30px;
    width: 100%;
    max-width: 600px;
    background: #333;
    border-radius: 10px;
    padding: 15px;
    overflow-y: auto;
    max-height: 300px;
  }
  #ranking h3 {
    font-size: 20px;
    margin-bottom: 12px;
    border-bottom: 1px solid #555;
    padding-bottom: 6px;
  }
  #ranking ul {
    list-style: none;
    max-height: 260px;
    overflow-y: auto;
    padding-right: 10px;
  }
  #ranking li {
    font-size: 16px;
    padding: 6px 0;
    border-bottom: 1px solid #444;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .badge {
    background: gold;
    color: black;
    font-weight: bold;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 14px;
  }
</style>

<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3922135705918865"
        crossorigin="anonymous"></script>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-analytics.js";
  import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCkSm4Zq2LUIGQr-v5Ix1ony4GBZLGvwqA",
    authDomain: "finger-gym-de648.firebaseapp.com",
    projectId: "finger-gym-de648",
    storageBucket: "finger-gym-de648.firebasestorage.app",
    messagingSenderId: "1093207272173",
    appId: "1:1093207272173:web:5a67893d026bbe2d0d7ae4",
    measurementId: "G-SSX4VGK20P"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  // 게임 변수
  let nickname = "";
  let totalDots = 5; // 기본 난이도 점 개수
  let dots = [];
  let startTime = 0;
  let touchedCount = 0;

  const nicknameInput = document.getElementById("nickname");
  const gameArea = document.getElementById("gameArea");
  const message = document.getElementById("message");
  const result = document.getElementById("result");
  const restartBtn = document.getElementById("restartBtn");
  const rankingList = document.getElementById("rankingList");

  // 닉네임 필수 체크 및 게임 시작
  function startGame() {
    nickname = nicknameInput.value.trim();
    if (!nickname) {
      alert("닉네임을 입력해주세요!");
      return;
    }
    resetGame();
    spawnDots(totalDots);
    message.textContent = `총 ${totalDots}개의 점을 빠르게 터치하세요!`;
    startTime = Date.now();
    touchedCount = 0;
    restartBtn.style.display = "none";
    result.textContent = "";
  }

  // 점 생성
  function spawnDots(count) {
    clearDots();
    dots = [];
    const gameRect = gameArea.getBoundingClientRect();

    for(let i=0; i<count; i++) {
      const dot = document.createElement("div");
      dot.classList.add("dot");
      const size = getRandomInt(30, 50); // 점 크기 30~50px
      dot.style.width = `${size}px`;
      dot.style.height = `${size}px`;
      dot.style.backgroundColor = getRandomColor();
      // 위치 랜덤 (게임 영역 내)
      const x = getRandomInt(0, gameRect.width - size);
      const y = getRandomInt(0, gameRect.height - size);
      dot.style.left = `${x}px`;
      dot.style.top = `${y}px`;
      dot.dataset.index = i;
      dot.addEventListener("click", onDotClick);
      gameArea.appendChild(dot);
      dots.push(dot);
    }
  }

  // 점 클릭 이벤트
  function onDotClick(e) {
    e.stopPropagation();
    const dot = e.target;
    dot.removeEventListener("click", onDotClick);
    dot.style.backgroundColor = "#555";
    dot.style.cursor = "default";
    touchedCount++;
    if (touchedCount === totalDots) {
      const elapsed = Date.now() - startTime;
      result.textContent = `완료 시간: ${elapsed} ms`;
      message.textContent = "기록이 저장됩니다!";
      saveRecord(nickname, elapsed);
      restartBtn.style.display = "inline-block";
    }
  }

  // 기록 저장
  async function saveRecord(nick, time) {
    try {
      await addDoc(collection(db, "fingerGymRanking"), {
        nick: nick,
        time: time,
        timestamp: serverTimestamp()
      });
    } catch(e) {
      console.error("Firestore 저장 오류:", e);
    }
  }

  // 점 제거
  function clearDots() {
    dots.forEach(d => d.remove());
    dots = [];
  }

  // 랜덤 정수 함수
  function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  // 랜덤 색상 함수
  function getRandomColor() {
    const colors = ["#2ecc71", "#e74c3c", "#f1c40f", "#3498db", "#9b59b6"];
    return colors[Math.floor(Math.random() * colors.length)];
  }

  // 랭킹 표시
  async function showRanking() {
    const rankingQuery = query(collection(db, "fingerGymRanking"), orderBy("time"), limit(10));
    onSnapshot(rankingQuery, (snapshot) => {
      rankingList.innerHTML = "";
      let rank = 1;
      const todayStr = new Date().toISOString().slice(0,10);
      snapshot.forEach(doc => {
        const data = doc.data();
        const li = document.createElement("li");
        li.textContent = `${data.nick} - ${data.time